import API from"../api";let elAddonsPage,dataHtml,dataAddons,elLPAddons;const queryString=window.location.search,urlParams=new URLSearchParams(queryString),tab=urlParams.get("tab");let elNotifyActionWrapper;const isHandling=[],getAddons=(e="")=>{const t=tab?`?tab=${tab}`:`?${e}`;fetch(API.admin.apiAddons+t,{method:"GET",headers:{"X-WP-Nonce":lpDataAdmin.nonce}}).then((e=>e.json())).then((e=>{const{status:t,message:a,data:s}=e;"success"===t?(dataHtml=s.html,dataAddons=s.addons):dataHtml=a})).catch((e=>{console.log(e)}))},addonsAction=(e,t)=>{const a=e.addon.slug;-1===isHandling.indexOf(a)&&(isHandling.push(a),fetch(API.admin.apiAddonAction,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},body:JSON.stringify({...e})}).then((e=>e.json())).then((e=>{const s=isHandling.indexOf(a);-1!==s&&isHandling.splice(s,1);const{status:n,message:o,data:d}=e;t&&t(n,o,d),handleNotify(n,o)})).catch((e=>{handleNotify("error",`error js: ${e}`),console.log(e)})))},handleNotify=(e,t)=>{const a=elNotifyActionWrapper.querySelector(".lp-notify-action").cloneNode(!0);a.classList.remove("clone"),elNotifyActionWrapper.insertBefore(a,elNotifyActionWrapper[0]);const s=a.querySelector(`.${a.classList.value}__success`),n=a.querySelector(`.${a.classList.value}__error`);"success"===e?(s.classList.add("show"),s.querySelector(".message").innerHTML=t):(n.classList.add("show"),n.querySelector(".message").innerHTML=t),elNotifyActionWrapper.classList.add("show"),setTimeout((()=>{a.remove();1===elNotifyActionWrapper.querySelectorAll(".lp-notify-action").length&&elNotifyActionWrapper.classList.remove("show")}),"success"===e?3e3:4e3)};getAddons();const searchAddons=e=>{const t=elAddonsPage.querySelectorAll(".lp-addon-item");let a=0;t.forEach((t=>{const s=t.querySelector("a").textContent;t.classList.contains("hide")||(s.toLowerCase().includes(e.toLowerCase())?(t.classList.remove("search-not-found"),a++):t.classList.add("search-not-found"))})),setGridItems(a)},setGridItems=e=>{e<4?elLPAddons.classList.add("max-3-items"):elLPAddons.classList.remove("max-3-items")},loadElData=setInterval((()=>{if(elAddonsPage||elNotifyActionWrapper){if(dataHtml&&elAddonsPage&&elNotifyActionWrapper){elAddonsPage.innerHTML=dataHtml,elLPAddons=elAddonsPage.querySelector("#lp-addons");const e=document.querySelector(".lp-nav-tab-wrapper"),t=e.cloneNode(!0);elAddonsPage.insertBefore(t,elAddonsPage.children[0]),t.style.display="flex",e.remove();const a=t.querySelector(".nav-tab.nav-tab-active span");setGridItems(parseInt(a.textContent)),clearInterval(loadElData)}}else elAddonsPage=document.querySelector(".lp-addons-page"),elNotifyActionWrapper=document.querySelector(".lp-notify-action-wrapper")}),1);document.addEventListener("DOMContentLoaded",(e=>{})),document.addEventListener("click",(e=>{const t=e.target;if("span"===t.tagName.toLowerCase()){e.preventDefault();const a=t.closest(".btn-addon-action");a&&a.click()}if(t.classList.contains("btn-addon-action")){e.preventDefault(),t.classList.add("handling");let a="";const s=t.closest(".lp-addon-item"),n=dataAddons[s.dataset.slug],o=t.dataset.action,d=s.querySelector(".lp-addon-item__purchase");if("purchase"===o)return d.style.display="block",void(d.querySelector(".purchase-install").style.display="flex");if("update-purchase-code"===o)return d.querySelector(".purchase-update").style.display="flex",void(d.style.display="block");if("buy"===o){const e=t.dataset.link;return void window.open(e,"_blank")}if("cancel"===o)return void(d.style.display="none");if("install"===o&&t.dataset.link){t.classList.remove("handling");const e=t.dataset.link;return void window.open(e,"_blank")}d&&(a=d.querySelector("input[name=purchase-code]").value);addonsAction({purchase_code:a,action:o,addon:n},(function(e,a,l){if("success"===e)if("install"===o){s.classList.add("installed","activated"),s.classList.remove("not_installed"),d.style.display="none";const e=document.querySelector(".nav-tab[data-tab=installed] span");e.textContent=parseInt(e.textContent)+1;const t=document.querySelector(".nav-tab[data-tab=not_installed] span");t.textContent=parseInt(t.textContent)-1}else if("update"===o){s.querySelector(".addon-version-current").innerHTML=n.version,s.classList.remove("update")}else"activate"===o?s.classList.add("activated"):"deactivate"===o&&s.classList.remove("activated");t.classList.remove("handling")}))}if(t.classList.contains("nav-tab")){e.preventDefault();document.querySelectorAll(".nav-tab").forEach((function(e){e.classList.remove("nav-tab-active")})),t.classList.add("nav-tab-active");const a=t.dataset.tab,s=elAddonsPage.querySelectorAll(".lp-addon-item");elAddonsPage.querySelector("#lp-search-addons__input").value="",urlParams.set("tab",a),window.history.pushState({},"",`${window.location.pathname}?${urlParams.toString()}`);let n=0;s.forEach((e=>{e.classList.remove("search-not-found"),"all"===a||e.classList.contains(a)?(e.classList.remove("hide"),n++):e.classList.add("hide")})),setGridItems(n)}})),document.addEventListener("input",(e=>{const t=e.target;if("lp-search-addons__input"===t.id){const e=t.value;searchAddons(e)}if(t.classList.contains("enter-purchase-code")){e.preventDefault();const a=t.value,s=t.closest(".lp-addon-item__purchase");if(s){s.querySelector("input[name=purchase-code]").value=a}}}));