import TomSelect from"tom-select";import{lpFetchAPI}from"../../utils.js";import Api from"../../api.js";export default function assignUserCourse(){let e,t,s,n,o,r;const a=(e,t,s)=>{if(!e)return;return t={...{options:[],plugins:{remove_button:{title:"Remove this item"}},load(e,t){s(e,t)}},...t},new TomSelect(e,t)},i=e=>{let t=[],s=[];"string"==typeof e.course_ids?t.push(e.course_ids):"object"==typeof e.course_ids&&(t=e.course_ids),"string"==typeof e.user_ids?s.push(e.user_ids):"object"==typeof e.user_ids&&(s=e.user_ids);const n=[];t.map(((e,t)=>{const o={};o.course_id=e,s.map(((e,t)=>{const s={...o,user_id:e};n.push(s)}))}));const o=n.slice(0,5),r=Math.ceil(n.length/5);return{packages:n,data:o,totalPage:r}},c=(s="",r,i)=>{const u=Api.admin.apiSearchCourses,l={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({c_search:s})};lpFetchAPI(u,l,{success:u=>{const l=u.data.map((e=>({value:e.ID,text:e.post_title+`(#${e.ID})`})));if(""===s){const s=e.querySelector("[name=course_ids]");s&&(t=a(s,{options:l},c));const r=n.querySelector("[name=course_ids]");r&&(o=a(r,{options:l},c))}"function"==typeof r&&("setupOptions"===r.name?i.setupOptions(l):r(l))}})},u=(t="",o,i)=>{const c=Api.admin.apiSearchUsers,l={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({search:t})};lpFetchAPI(c,l,{success:c=>{const l=c.data.map((e=>({value:e.ID,text:`${e.display_name} (#${e.ID}) - ${e.user_email}`})));if(""===t){const t=e.querySelector("[name=user_ids]");t&&(s=a(t,{options:l},u));const o=n.querySelector("[name=user_ids]");o&&(r=a(o,{options:l},u))}"function"==typeof o&&("setupOptions"===o.name?i.setupOptions(l):o(l))}})},l=(n,o,r,a)=>{const i=Api.admin.apiAssignUserCourse,c={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({data:o,page:r,totalPage:a})},u=e.querySelector(".percent"),p=e.querySelector(".lp-button-assign-course"),d=e.querySelector(".message");p.disabled=!0,lpFetchAPI(i,c,{success:e=>{const{status:r,message:i}=e;if("success"===r){let t=parseInt(e.data.page);const s=5*t,r=s+5;o=n.slice(s,r),u.innerHTML=e.data.percent,l(n,o,++t,a)}else"finished"===r?(u.innerHTML="",d.style.color="green",d.innerHTML=i,setTimeout((()=>{d.innerHTML=""}),2e3),p.disabled=!1,t.clear(),s.clear()):"error"===r&&(p.disabled=!1,d.style.color="red",d.innerHTML=i,setTimeout((()=>{d.innerHTML=""}),2e3))},error:e=>{p.disabled=!1,d.innerHTML=e.message},completed:()=>{}})},p=(e,t,s,a)=>{const i=Api.admin.apiUnAssignUserCourse,c={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify({data:t,page:s,totalPage:a})},u=n.querySelector(".percent"),l=n.querySelector(".lp-button-unassign-course"),d=n.querySelector(".message");l.disabled=!0,lpFetchAPI(i,c,{success:s=>{const{status:n,message:i}=s;if("success"===n){let n=parseInt(s.data.page);const o=5*n,r=o+5;t=e.slice(o,r),u.innerHTML=s.data.percent,p(e,t,++n,a)}else"finished"===n?(u.innerHTML="",d.style.color="green",d.innerHTML=i,setTimeout((()=>{d.innerHTML=""}),2e3),l.disabled=!1,o.clear(),r.clear()):"error"===n&&(l.disabled=!1,d.style.color="red",d.innerHTML=i,setTimeout((()=>{d.innerHTML=""}),2e3))},error:e=>{l.disabled=!1,d.innerHTML=e.message},completed:()=>{}})};document.addEventListener("DOMContentLoaded",(()=>{e=document.querySelector("#lp-assign-user-course-form"),n=document.querySelector("#lp-unassign-user-course-form"),e&&(c(),u(),document.querySelector("form")&&document.addEventListener("submit",(e=>{const t=e.target,s=new FormData(e.target),n=Object.fromEntries(Array.from(s.keys(),(e=>{const t=s.getAll(e);return[e,t.length>1?t:t.pop()]})));if("lp-assign-user-course-form"===t.id){if(e.preventDefault(),!confirm("Are you sure you want to Assign?"))return;const{packages:t,data:s,totalPage:o}=i(n);l(t,s,1,o)}else if("lp-unassign-user-course-form"===t.id){if(e.preventDefault(),!confirm("Are you sure you want to Unassign?"))return;const{packages:t,data:s,totalPage:o}=i(n);p(t,s,1,o)}})))}))}