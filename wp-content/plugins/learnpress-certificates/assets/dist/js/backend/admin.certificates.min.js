(()=>{var e,t;e=jQuery,t={__onSelect:null,__multiple:!1,__context:null,activeFrame:!1,frame(t){t=e.extend({},t||{});const i=100*Math.random();return this._frame||(this._frame=[]),this._frame[i]||(this._frame[i]=wp.media({title:t.title||"Select Media",button:{text:t.button_text||"Insert"},multiple:t.multiple}),this._frame[i].state("library").on("select",this.select)),this._frame[i]},select(){if("function"==typeof t.__onSelect){let e=this.get("selection");e=t.__multiple?e.toJSON():e.single().toJSON(),t.__onSelect.call(t._frame,e,t.__context),t.__onSelect=null,t.__context=null}},open(i){"function"==typeof(i=e.extend({multiple:!1,context:null,onSelect(){}},i||{})).onSelect&&(t.__onSelect=i.onSelect,t.__multiple=i.multiple,t.__context=i.context,t.frame(i).open())}},e(document).ready((function(){var i={now:Date.now||function(){return(new Date).getTime()},debounce(e,t,a){let s,r,n,o,c;var l=function(){const d=i.now()-o;d<t&&d>=0?s=setTimeout(l,t-d):(s=null,a||(c=e.apply(n,r),s||(n=r=null)))};return function(){n=this,r=arguments,o=i.now();const d=a&&!s;return s||(s=setTimeout(l,t)),d&&(c=e.apply(n,r),n=r=null),c}}};function a(t,i){e.ajax({url:"",data:{"lp-ajax":"update-course-certificate",course_id:t,cert_id:i},success(){e("#certificate-browser").find(".theme.updating").removeClass("updating")}})}if(e(document).on("click",".button-assign-certificate",(function(t){t.preventDefault();const i=e("#certificate-browser").find(".themes"),s=i.find(".theme"),r=e(this).closest(".theme");s.removeClass("active"),i.prepend(r.addClass("active updating")),a(e("#post_ID").val(),r.data("id"))})).on("click",".button-remove-certificate",(function(t){t.preventDefault(),t.stopPropagation(),e(this).closest(".theme").removeClass("active").addClass("updating"),a(e("#post_ID").val(),0)})),"undefined"==typeof lpCertificatesSettings)return console.log("lpCertificatesSettings is not defined!"),void console.log("Only load when edit certificate");window.$LP_Certificates=new Vue({el:"#learn-press-certificates",template:"#tmpl-certificates",data:e.extend({dragover:!1,viewport:{width:0,height:0,templateWidth:0,templateHeight:0,ratio:1},$view:!1,$layerOptions:null,loaded:!1,i18n:{},template:"xxx"},lpCertificatesSettings),computed:{getMaxWidth:()=>Math.random()},created(){const e=this;setTimeout((function(){e.init()}),300)},methods:{init(){const t=this;this.$img=this.$(".cert-template"),this.$img_preload=document.getElementById("cert-template-preload"),this.initCanvas(),this.initDragAndDrop(),e("#cert-template-preload").length&&(this.viewport={width:this.$img_preload.width,height:this.$img_preload.height,templateWidth:this.$img_preload.naturalWidth,templateHeight:this.$img_preload.naturalHeight,ratio:this.$img_preload.width/this.$img_preload.naturalWidth},this.updateView()),this.$img.on("load",(function(){t.viewport={width:this.width,height:this.height,templateWidth:this.naturalWidth,templateHeight:this.naturalHeight,ratio:this.width/this.naturalWidth},console.log(t.viewport),t.loaded&&t.ajaxUpdateTemplate(),t.updateView()})).trigger("load"),this.$layerOptions=e(".cert-layer-options"),e(document).on("certificate/change-layer-option",i.debounce((function(e,i){const a={};a[i.name]=i.value,t.updateActiveLayer(a)}),100)),e(window).on("resize.certificate-update-view",(function(){let i=e(this).data("timer");i&&clearTimeout(i),i=setTimeout((function(){t.updateView()}),300)})),e(document).on("click",".layer-center",(function(){switch(e(this).data("center")){case"center-h":t.centerH();break;case"center-v":t.centerV();break;case"center":t.center()}})),e(document).on("click",".cert-layers .layer",(function(i){const a=t.findLayer(e(this).data("layer"));a&&t.$canvas.setActiveObject(a),e(i.target).is("a")&&(t.deleteLayer(),i.preventDefault())})),this.loaded=!0},findLayer(e){const t=this.$canvas.getObjects();for(const i in t)if(t[i].name===e)return t[i];return!1},addCustomPreview(){},centerV(e){if(e||(e=this.getActiveLayer()),!e)return;const t={top:(this.$canvas.height/this.viewport.ratio-e.height*Math.abs(e.scaleY))/2};"center"===e.originY&&(t.top+=e.height/2),e.set(t),e.setCoords(),this.updateView(),this.updateActiveLayer(t)},centerH(e){if(e||(e=this.getActiveLayer()),!e)return;const t={left:(this.$canvas.width/this.viewport.ratio-e.width*Math.abs(e.scaleX))/2};"center"===e.originX&&(t.left+=e.width/2),e.set(t),e.setCoords(),this.updateView(),this.updateActiveLayer(t)},center(e){this.centerV(e),this.centerH(e)},deleteLayer(){if(!confirm(this.i18n.confirm_remove_layer))return;const t=this.getActiveLayer(),i=t.get("name");t&&(this.$canvas.remove(t),Vue.http.post("",{layer:i},{emulateJSON:!0,params:{"lp-ajax":"cert-remove-layer",id:this.id}}).then((function(){e(".cert-layers").children().filter('[data-layer="'+i+'"]').remove()})))},getActiveLayer(){return this.$canvas.getActiveObject()},getMaxWidth(){return this.$().width()-60},updateActiveLayer(e,t){if(t=t||this.getActiveLayer()){for(const i in e)this.setLayerProp(t,i,e[i]);this.$canvas.renderAll(),this.ajaxUpdateLayer(t)}},calculate(){this.viewport=e.extend(this.viewport,{width:this.$img.width(),height:this.$img.height(),ratio:this.$img.width()/this.viewport.templateWidth})},updateView(){const e=this.getMaxWidth();this.calculate(),this.viewport.templateWidth<e&&this.template?this.$("#cert-design-view").css("width",this.viewport.width+60).addClass("small"):this.$("#cert-design-view").css("width","").removeClass("small"),this.$canvas.setHeight(this.viewport.height),this.$canvas.setWidth(this.viewport.width),this.$canvas.setZoom(this.viewport.ratio),this.$canvas.calcOffset(),this.$canvas.renderAll()},$(t){const i=e(this.$el);return t?i.find(t):i},getLayerOptions(e){return e?e.toObject(this.getExtendedFields()):{}},getExtendedFields(){let t=["name","fieldType","display","customText","format","variable","formatDate","qr_size","fontFile"],i=e(document).triggerHandler("learn_press_certificates_extended_fields",[t]);return void 0===i&&(i=t),i},showControls(e){},showLines(){const e=this.getActiveLayer();e?(this.$("#cert-design-view").addClass("dragover"),this.$("#cert-design-line-horizontal").css("top",e.top*this.viewport.ratio),this.$("#cert-design-line-vertical").css("left",e.left*this.viewport.ratio-1)):this.hideLines()},hideLines(){this.$("#cert-design-view").removeClass("dragover")},toFixedX:e=>Math.ceil(10*e)/10,hideControls(){},getLayers(){const e={},t=this.$canvas.getObjects();for(const i in t)e[t[i].name]=this.getLayerOptions(t[i]);return e},ajaxUpdateLayers:i.debounce((function(){return Vue.http.post("",{layers:this.getLayers()},{emulateJSON:!0,params:{"lp-ajax":"cert-update-layers",id:this.id}})}),300),ajaxUpdateLayer:i.debounce((function(t,i){t=e.isPlainObject(t)?t:this.getLayerOptions(t);const a=this;if(JSON.stringify(t).md5()!==t.hash)return Vue.http.post("",{layer:t,"load-settings":i?"yes":"no"},{emulateJSON:!0,params:{"lp-ajax":"cert-update-layer",id:this.id}}).then((function(t){const i=e(t.body);i.hasClass("cert-layer-options")&&(a.$layerOptions=i,e("#certificates-options").removeClass("loading").find(".inside").html(a.$layerOptions))}))}),300),ajaxUpdateTemplate:i.debounce((function(){return Vue.http.post("",{template:this.template},{emulateJSON:!0,params:{"lp-ajax":"cert-update-template",id:this.id}})}),300),ajaxLoadLayer:i.debounce((function(t){const i=this;return e("#certificates-options").show().addClass("loading"),Vue.http.post("",{layer:t.get("name")},{emulateJSON:!0,params:{"lp-ajax":"cert-load-layer",id:this.id}}).then((function(t){i.$layerOptions=e(t.body),e("#certificates-options").removeClass("loading").find(".inside").html(i.$layerOptions)}))}),300),addLayerList(t){const i=e('<div class="layer" data-layer="'+t.name+'">Layer #'+t.text+'<a href=""></a></div>');e(".cert-layers").prepend(i)},addLayer(t,i){return i=e.extend({setActive:!0},i||{}),e.isPlainObject(t)&&(t=this.createLayer(t)),t&&(this.loaded&&this.ajaxUpdateLayer(t,!0),this.$canvas.add(t),this.addLayerList(t),i.setActive&&this.$canvas.setActiveObject(t),this.$canvas.renderAll()),t},createLayer(t){try{var i=e.extend({fontSize:24,left:0,top:0,lineHeight:1,originX:"center",originY:"center",fontFamily:"Helvetica",name:this.uniqueId(),fieldType:"custom",variable:""},t),a=t.text||"",s=new fabric.Text(a,i),r=this;"verified-link"==t.fieldType&&(i.qr_size=40);const n=/^(https?|s?ftp):\/\//i.test(t.text);if("verified-link"==t.fieldType&&t.qr_size>0&&n){const e=new Image;i.type="image",i.height=i.qr_size,i.width=i.qr_size,e.crossOrigin="Anonymous",e.src=t.text,s=new fabric.Image(e,i)}s.set({borderColor:"#AAA",cornerColor:"#666",cornerSize:7,transparentCorners:!0,padding:0}),e.each(i,(function(e,t){r.setLayerProp(s,e,t)}));const o=e(document).triggerHandler("learn_press_certificate_layer_obj",[s,t]);"object"==typeof o&&(s=o)}catch(e){console.log(e)}return s},updateLayerOptions:i.debounce((function(t){const i=this,a=this.getLayerOptions(t||this.getActiveLayer()),s=this.$layerOptions.find(":input");e.each(a,(function(e,t){switch(e){case"fontFamily":break;case"fontStyle":case"fontWeight":"normal"===t&&(t="");break;case"originY":"middle"===t&&(t="center");break;case"top":case"left":t=parseInt(t);break;case"angle":case"scaleX":case"scaleY":t=i.toFixedX(t)}s.filter('[name="'+e+'"]').val(t)})),e("#certificates-options").show()}),300),setLayerProp(t,i,a){const s={};switch(void 0===a&&(a=""),i){case"color":s.fill=a;break;case"scaleX":case"scaleY":isNaN(a)&&(a=0),a<0?"scaleX"===i?t.flipX=!0:t.flipY=!0:"scaleX"===i?t.flipX=!1:t.flipY=!1,s[i]=this.toFixedX(Math.abs(a));break;case"top":case"left":isNaN(a)&&(a=0),s[i]=parseInt(a);break;case"angle":s[i]=this.toFixedX(a);break;case"fontFamily":a=""+a,t.set("fontFamily",a.replace(/\+/," "));break;default:s[i]=a}s.flipX&&(s.scaleX=-this.toFixedX(s.scaleX)),s.flipY&&(s.scaleY=-this.toFixedX(s.scaleY)),e.each(s,(function(e,i){t.set(e,i)})),t.setCoords()},onObjectSelected(t){const i=this.getLayerOptions(t.target);for(const e in i)this.setLayerProp(t.target,e,i[e]);e(".cert-layers").children().removeClass("active").filter('[data-layer="'+t.target.name+'"]').addClass("active"),this.ajaxLoadLayer(t.target)},onObjectMoving(e){this.updateLayerOptions(),this.ajaxUpdateLayer(e.target),this.showLines()},onObjectRotating(e){this.updateLayerOptions(),this.ajaxUpdateLayer(e.target);const t=this.$canvas.getActiveObject(),i=this.toFixedX(t.angle);this.setPropSlider("angle",i),this.hideLines()},onObjectMouseup(){this.hideLines()},onObjectMousedown(){this.showLines()},onBeforeSelectionCleared(t){e("#certificates-options").hide(),e(".cert-layers").children().removeClass("active"),this.hideLines()},onObjectModified(e){this.showControls(e)},limitObjectScale(){let e=this.$canvas.getActiveObject(),t=this.toFixedX(e.scaleX),i=this.toFixedX(e.scaleY);e.flipX&&(t=-t),e.flipY&&(i=-i),this.ajaxUpdateLayer(e),this.setPropSlider("scaleX",t),this.setPropSlider("scaleY",i)},setPropSlider(e,t){this.$layerOptions.find('input[name="'+e+'"]').val(t).siblings(".cert-option-slider").slider("option","value",t)},initCanvas(){if(!this.$canvas){const t=this,a=this.$("canvas");this.$canvas=new fabric.Canvas(a.get(0),this.layers),this.$canvas.on({"object:selected":this.onObjectSelected,"object:moving":this.onObjectMoving,"object:rotating":this.onObjectRotating,"mouse:up":this.onObjectMouseup,"mouse:down":this.onObjectMousedown,"before:selection:cleared":this.onBeforeSelectionCleared,"object:modified":this.onObjectModified}).observe("object:scaling",this.limitObjectScale),this.$canvas.selection=!1,e.each(this.layers,(function(e,i){i.type&&t.addLayer(i,{setActive:!1})})),i.debounce(this.updateView,300)(),console.log("initCanvas")}},initDragAndDrop(){const t=this;this.$view=e(this.$el).find("#cert-design-view"),e(".cert-fields li").draggable({helper:"clone",drag(e,i){const a=t.$view.offset();t.dragover={left:i.offset.left-a.left+26,top:i.offset.top-a.top+13},t.dragover.left<0||t.dragover.top<0?t.dragover=!1:t.updateLines()}}),e("#cert-design-editor").droppable({over(e,i){t.dragover=!0,t.dragover=i.position,t.updateLines()},out(){t.dragover=!1},drop(e,i){t.dragover=!1;const a=t.$view.find(".canvas-container").offset(),s=(i.offset.left-a.left+i.draggable.outerWidth()/2)/t.viewport.ratio,r=(i.offset.top-a.top+i.draggable.outerHeight()/2)/t.viewport.ratio;t.addLayerByDrop({top:r,left:s,text:i.draggable.text().trim(),fieldType:i.draggable.data("type")})}}),e(".cert-layers").sortable({axis:"y",start(t,i){const a=e(this).children();i.item.data("position",a.index(i.item))},update(i,a){const s=t.$canvas.getActiveObject();if(!s)return;let r=e(this).children(),n=a.item.data("position"),o=r.index(a.item),c=0;if(o>n)for(c=0;c<o-n;c++)s.sendBackwards();else for(c=0;c<n-o;c++)s.bringForward();t.ajaxUpdateLayers()}})},updateRulers(){this.dragover},updateLines(){this.dragover&&e(this.$el).find(".cert-design-line").filter(".horizontal").css("top",this.dragover.top).end().filter(".vertical").css("left",this.dragover.left)},uniqueId(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+e()+e()},selectTemplate(){t.open({context:this,onSelect(e,t){e.sizes?t.template=e.sizes.full.url:t.template=e.url,t.updateView()}})},setPreview(){alert(0)},addLayerByDrop(e){const t=this.createLayer(e);return t&&(this.addLayer(t),this.$canvas.calcOffset(),this.$canvas.renderAll()),t}}})}))})();